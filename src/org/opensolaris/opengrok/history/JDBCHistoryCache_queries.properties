#
# CDDL HEADER START
#
# The contents of this file are subject to the terms of the
# Common Development and Distribution License (the "License").
# You may not use this file except in compliance with the License.
#
# See LICENSE.txt included in this distribution for the specific
# language governing permissions and limitations under the License.
#
# When distributing Covered Code, include this CDDL HEADER in each
# file and include the License file at LICENSE.txt.
# If applicable, add the following below this CDDL HEADER, with the
# fields enclosed by brackets "[]" replaced with your own identifying
# information: Portions Copyright [yyyy] [name of copyright owner]
#
# CDDL HEADER END
#

#
# Copyright 2009 Sun Microsystems, Inc.  All rights reserved.
# Use is subject to license terms.
#

createTableRepositories=\
  CREATE TABLE REPOSITORIES (\
    ID INT GENERATED ALWAYS AS IDENTITY \
        CONSTRAINT REPOSITORIES_PK PRIMARY KEY, \
    PATH VARCHAR(32672) \
        CONSTRAINT REPOSITORIES_PATH_UNIQUE UNIQUE NOT NULL)

createTableDirectories=\
  CREATE TABLE DIRECTORIES (\
    ID INT CONSTRAINT DIRECTORIES_PK PRIMARY KEY, \
    PATH VARCHAR(32672) NOT NULL, \
    REPOSITORY INT NOT NULL \
        CONSTRAINT DIRS_FK_REPO REFERENCES REPOSITORIES ON DELETE CASCADE, \
    CONSTRAINT DIRECTORIES_REPO_PATH_UNIQUE UNIQUE (REPOSITORY, PATH))

createTableFiles=\
  CREATE TABLE FILES (\
    ID INT CONSTRAINT FILES_PK PRIMARY KEY, \
    NAME VARCHAR(32672) NOT NULL, \
    DIRECTORY INT NOT NULL \
        CONSTRAINT FILES_FK_DIR REFERENCES DIRECTORIES ON DELETE CASCADE, \
    CONSTRAINT FILES_DIR_NAME_UNIQUE UNIQUE (DIRECTORY, NAME))

createTableAuthors=\
  CREATE TABLE AUTHORS (\
    ID INT CONSTRAINT AUTHORS_PK PRIMARY KEY, \
    REPOSITORY INT NOT NULL \
        CONSTRAINT AUTHORS_FK_REPO REFERENCES REPOSITORIES ON DELETE CASCADE, \
    NAME VARCHAR(32672), \
    CONSTRAINT AUTHORS_REPO_NAME_UNIQUE UNIQUE (REPOSITORY, NAME))

createTableChangesets=\
  CREATE TABLE CHANGESETS (\
    ID INT CONSTRAINT CHANGESETS_PK PRIMARY KEY, \
    REPOSITORY INT NOT NULL \
        CONSTRAINT CHANGESETS_FK_REPO \
            REFERENCES REPOSITORIES ON DELETE CASCADE, \
    REVISION VARCHAR(1024) NOT NULL, \
    AUTHOR INT NOT NULL \
        CONSTRAINT CHANGESETS_FK_AUTH REFERENCES AUTHORS ON DELETE CASCADE, \
    TIME TIMESTAMP NOT NULL, \
    MESSAGE VARCHAR(32672) NOT NULL, \
    CONSTRAINT CHANGESETS_REPO_REV_UNIQUE UNIQUE (REPOSITORY, REVISION))

createIndexChangesetsRepoIdDesc=\
  CREATE UNIQUE INDEX IDX_CHANGESETS_REPO_ID_DESC ON \
    CHANGESETS(REPOSITORY, ID DESC)

createTableDirchanges=\
  CREATE TABLE DIRCHANGES (\
    DIRECTORY INT NOT NULL \
        CONSTRAINT DIRCHANGES_FK_DIR REFERENCES DIRECTORIES ON DELETE CASCADE, \
    CHANGESET INT NOT NULL \
        CONSTRAINT DIRCHANGES_FK_CS REFERENCES CHANGESETS ON DELETE CASCADE, \
    CONSTRAINT DIRCHANGES_PK PRIMARY KEY (DIRECTORY, CHANGESET))

createTableFilechanges=\
  CREATE TABLE FILECHANGES (\
    FILE INT NOT NULL \
        CONSTRAINT FILECHANGES_FK_FILE REFERENCES FILES ON DELETE CASCADE, \
    CHANGESET INT NOT NULL \
        CONSTRAINT FILECHANGES_FK_CS REFERENCES CHANGESETS ON DELETE CASCADE, \
    CONSTRAINT FILECHANGES_PK PRIMARY KEY (FILE, CHANGESET))

hasCacheForDirectory=\
  SELECT 1 FROM REPOSITORIES R, DIRECTORIES D \
  WHERE D.REPOSITORY = R.ID AND R.PATH = ? AND D.PATH = ?

getFileHistory=\
  SELECT CS.REVISION, A.NAME, CS.TIME, CS.MESSAGE, CS.ID \
  FROM \
      CHANGESETS CS, FILECHANGES FC, REPOSITORIES R, FILES F, DIRECTORIES D, \
      AUTHORS A \
  WHERE \
      R.PATH = ? AND D.PATH = ? AND F.NAME = ? AND \
      D.REPOSITORY = R.ID AND D.ID = F.DIRECTORY AND \
      CS.ID = FC.CHANGESET \
      AND FC.FILE = F.ID AND A.ID = CS.AUTHOR  \
  ORDER BY CS.ID DESC

getDirHistory=\
  SELECT CS.REVISION, A.NAME, CS.TIME, CS.MESSAGE, CS.ID \
  FROM \
      CHANGESETS CS, DIRCHANGES DC, REPOSITORIES R, DIRECTORIES D, AUTHORS A \
  WHERE \
      R.PATH = ? AND D.PATH = ? AND D.REPOSITORY = R.ID AND \
      CS.ID = DC.CHANGESET \
      AND DC.DIRECTORY = D.ID AND A.ID = CS.AUTHOR \
  ORDER BY CS.ID DESC

getFilesInChangeset=\
  SELECT D.PATH || '/' || F.NAME FROM DIRECTORIES D, FILES F, FILECHANGES FC \
  WHERE D.ID = F.DIRECTORY AND F.ID = FC.FILE AND FC.CHANGESET = ?

getRepository=SELECT ID FROM REPOSITORIES WHERE PATH = ?

addRepository=INSERT INTO REPOSITORIES(PATH) VALUES ?

addChangeset=\
  INSERT INTO CHANGESETS (REPOSITORY, REVISION, AUTHOR, TIME, MESSAGE, ID) \
  VALUES (?,?,?,?,?,?)

addDirchange=INSERT INTO DIRCHANGES(CHANGESET, DIRECTORY) VALUES (?,?)

addFilechange=INSERT INTO FILECHANGES(CHANGESET, FILE) VALUES (?,?)

getAuthors=SELECT NAME, ID FROM AUTHORS WHERE REPOSITORY = ?

addAuthor=INSERT INTO AUTHORS (REPOSITORY, NAME, ID) VALUES (?,?,?)

getDirectories=SELECT PATH, ID FROM DIRECTORIES WHERE REPOSITORY = ?

getFiles=\
  SELECT D.PATH || '/' || F.NAME, F.ID FROM FILES F, DIRECTORIES D \
  WHERE D.REPOSITORY = ? AND F.DIRECTORY = D.ID

addDirectory=INSERT INTO DIRECTORIES(REPOSITORY, PATH, ID) VALUES (?,?,?)

addFile=INSERT INTO FILES(DIRECTORY, NAME, ID) VALUES (?,?,?)

getLatestCachedRevision=\
  SELECT REVISION FROM CHANGESETS WHERE ID = \
    (SELECT MAX(CS.ID) FROM CHANGESETS CS, REPOSITORIES R \
            WHERE CS.REPOSITORY = R.ID AND R.PATH = ?)

getMaxFileId=SELECT MAX(ID) FROM FILES

getMaxDirId=SELECT MAX(ID) FROM DIRECTORIES

getMaxChangesetId=SELECT MAX(ID) FROM CHANGESETS

getMaxAuthorId=SELECT MAX(ID) FROM AUTHORS
